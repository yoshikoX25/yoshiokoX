// ▼ AIへの「性格設定」です。ここを変えるとキャラが変わります。
const SYSTEM_PROMPT = `
あなたは「世界一優しい全肯定カウンセラー」です。
ユーザーの発言に対して、以下のルールで返信してください。
1. 否定、アドバイス、説教は一切禁止。
2. どんなにネガティブな発言も「それは辛かったですね」「あなたは悪くないですよ」と全肯定する。
3. ユーザーの感情に寄り添い、とにかく甘やかす言葉をかける。
4. 返答は3〜4行程度の短めで、温かみのある敬語を使う。
`;

const inputField = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const chatBox = document.getElementById('chat-box');
const apiKeyInput = document.getElementById('api-key');

// 会話の履歴を保存しておく配列（直前の文脈を覚えるため）
let conversationHistory = [
    { role: "system", content: SYSTEM_PROMPT }
];

function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    div.innerHTML = text.replace(/\n/g, '<br>');
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function callOpenAI(userText, apiKey) {
    // 読み込み中...を表示
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message bot-message';
    loadingDiv.innerText = '（考え中...）';
    loadingDiv.id = 'loading';
    chatBox.appendChild(loadingDiv);

    // 履歴にユーザーのメッセージを追加
    conversationHistory.push({ role: "user", content: userText });

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini", // 安くて賢い最新モデル
                messages: conversationHistory
            })
        });

        const data = await response.json();
        
        // 読み込み中を消す
        document.getElementById('loading').remove();

        if (data.error) {
            addMessage("エラー: APIキーが正しいか確認してください。", 'bot');
            console.error(data.error);
            return;
        }

        const aiText = data.choices[0].message.content;
        
        // AIの返事を履歴に追加（これで会話が繋がる）
        conversationHistory.push({ role: "assistant", content: aiText });
        
        addMessage(aiText, 'bot');

    } catch (error) {
        document.getElementById('loading').remove();
        addMessage("通信エラーが発生しました。", 'bot');
    }
}

function handleSend() {
    const text = inputField.value.trim();
    const apiKey = apiKeyInput.value.trim();

    if (text === "") return;

    if (apiKey === "") {
        alert("画面上の入力欄にOpenAI APIキーを入れてください！\n（GitHubのコードに直接書くのは危険なため）");
        return;
    }

    addMessage(text, 'user');
    inputField.value = "";
    
    // AIを呼ぶ
    callOpenAI(text, apiKey);
}

sendBtn.addEventListener('click', handleSend);
inputField.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleSend();
});
